<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Climate Radar Chart</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 20px;
      text-align: center;
    }
    h1 {
      margin-bottom: 1rem;
    }
    svg {
      background: #fff;
      border: 1px solid #ddd;
      margin: auto;
      display: block;
    }
    .axisLabel {
      font-size: 12px;
      fill: #333;
    }
    .legend {
      font-size: 12px;
      fill: #333;
    }
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }
  </style>
</head>
<body>
  <h1>Climate Radar Chart â€“ Average Values</h1>
  <svg id="radarChart" width="700" height="700"></svg>
  <div id="tooltip" class="tooltip"></div>
  
  <script>
    // The CSV URL for your merged climate data
    const CLIMATE_CSV_URL = "https://gist.githubusercontent.com/mas5021/546c5cb1aaaaed863bb098b86f71503e/raw/1897725dabe21080a628a0022fa79942c48e1483/merged_climate.csv";
    
    // List of variables to include in the radar chart.
    const axes = ["SolarIrradiance", "CloudCover", "Precipitation", "Temperature", "VegetationIndex"];
    
    // Set up the SVG container.
    const svg = d3.select("#radarChart");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const margin = {top: 50, right: 50, bottom: 50, left: 50};
    
    // Center coordinates.
    const centerX = width / 2;
    const centerY = height / 2;
    // The maximum radius for our radar chart.
    const radius = Math.min(width, height) / 2 - Math.max(margin.left, margin.right);
    
    // Create a group element at the center.
    const g = svg.append("g")
                 .attr("transform", `translate(${centerX}, ${centerY})`);
    
    const tooltip = d3.select("#tooltip");
    
    // Load the CSV file.
    d3.csv(CLIMATE_CSV_URL, d => {
      return {
        Year: +d.Year,
        SolarIrradiance: +d.SolarIrradiance,
        CloudCover: +d.CloudCover,
        Precipitation: +d.Precipitation,
        Temperature: +d.Temperature,
        VegetationIndex: +d.VegetationIndex
      };
    }).then(data => {
      // Filter out rows that have any NaN for the key columns.
      data = data.filter(d =>
        !isNaN(d.Year) &&
        axes.every(axis => !isNaN(d[axis]))
      );
      
      if(data.length === 0) {
        console.error("No valid data rows found. Check CSV column names and data values.");
        return;
      }
      
      // For each variable, compute the average value.
      const averages = axes.map(axis => ({
        axis: axis,
        avg: d3.mean(data, d => d[axis])
      }));
      
      // Also compute the extents for normalization on each axis.
      const extents = {};
      axes.forEach(axis => {
        extents[axis] = d3.extent(data, d => d[axis]);
      });
      
      // Normalize the average for each variable to the [0,1] range.
      averages.forEach(d => {
        const [minVal, maxVal] = extents[d.axis];
        d.norm = (d.avg - minVal) / (maxVal - minVal);
      });
      
      console.log("Averages:", averages);
      
      // Draw the radar chart using these averaged normalized values.
      drawRadarChart(averages);
    }).catch(error => {
      console.error("Error loading CSV file:", error);
    });
    
    // Function to draw the radar chart.
    function drawRadarChart(averages) {
      // Number of axes in the radar chart.
      const numAxes = averages.length;
      // Angular scale: distribute axes evenly around the circle.
      const angleScale = d3.scaleBand()
                           .domain(averages.map(d => d.axis))
                           .range([0, 2 * Math.PI])
                           .padding(0.1);
      
      // Radial scale: maps normalized values (0 to 1) to radius (0 to defined radius)
      const rScale = d3.scaleLinear()
                       .domain([0, 1])
                       .range([0, radius]);
      
      // Draw reference circles (e.g., at 0.25, 0.5, 0.75, and 1.0)
      const levels = [0.25, 0.5, 0.75, 1.0];
      levels.forEach(level => {
        g.append("circle")
         .attr("r", rScale(level))
         .attr("fill", "none")
         .attr("stroke", "#CDCDCD")
         .attr("stroke-dasharray", "2,2");
      });
      
      // Draw radial lines for each axis.
      averages.forEach(d => {
        const angle = angleScale(d.axis) + angleScale.bandwidth()/2 - Math.PI/2;
        const x = rScale(1) * Math.cos(angle);
        const y = rScale(1) * Math.sin(angle);
        g.append("line")
         .attr("x1", 0)
         .attr("y1", 0)
         .attr("x2", x)
         .attr("y2", y)
         .attr("stroke", "#CDCDCD")
         .attr("stroke-width", 1);
        // Axis label positioned just outside the outer circle.
        g.append("text")
         .attr("x", (rScale(1) + 15) * Math.cos(angle))
         .attr("y", (rScale(1) + 15) * Math.sin(angle))
         .attr("text-anchor", "middle")
         .attr("class", "axisLabel")
         .text(d.axis)
         .on("mouseover", (event, dd) => {
           // On hover over axis labels, display a tooltip with the average value.
           tooltip.style("opacity", 1)
                  .html(`<strong>${d.axis}</strong><br>Avg: ${d.avg.toFixed(2)}`)
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY - 20) + "px");
         })
         .on("mouseout", () => {
           tooltip.style("opacity", 0);
         });
      });
      
      // Create a radar line generator using d3.lineRadial.
      const radarLine = d3.lineRadial()
                          .angle((d, i) => i * 2 * Math.PI / numAxes)
                          .radius(d => rScale(d.norm))
                          .curve(d3.curveLinearClosed);
      
      // Order the data in the same order as the axes.
      const radarData = averages.sort((a, b) => {
        return angleScale(a.axis) - angleScale(b.axis);
      });
      
      // Draw the radar polygon.
      g.append("path")
       .datum(radarData)
       .attr("d", radarLine)
       .attr("fill", "#2980b9")
       .attr("fill-opacity", 0.5)
       .attr("stroke", "#2980b9")
       .attr("stroke-width", 2)
       .on("mouseover", (event, d) => {
         tooltip.style("opacity", 1)
                .html(radarData.map(v => `<strong>${v.axis}:</strong> ${v.avg.toFixed(2)}`).join("<br>"))
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px");
       })
       .on("mouseout", () => {
         tooltip.style("opacity", 0);
       });
      
      // Draw small circles for each vertex of the radar chart.
      g.selectAll(".vertex")
       .data(radarData)
       .enter()
       .append("circle")
       .attr("class", "vertex")
       .attr("r", 4)
       .attr("cx", (d, i) => rScale(d.norm) * Math.cos(i * 2 * Math.PI / numAxes - Math.PI/2))
       .attr("cy", (d, i) => rScale(d.norm) * Math.sin(i * 2 * Math.PI / numAxes - Math.PI/2))
       .attr("fill", "#fff")
       .attr("stroke", "#2980b9")
       .attr("stroke-width", 2)
       .on("mouseover", (event, d) => {
         tooltip.style("opacity", 1)
                .html(`<strong>${d.axis}</strong><br>Avg: ${d.avg.toFixed(2)}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px");
       })
       .on("mouseout", () => {
         tooltip.style("opacity", 0);
       });
    }
  </script>
</body>
</html>
